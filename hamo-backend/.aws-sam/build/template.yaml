AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Hamo Backend - Lambda + HTTP API + Cognito
Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 15
    MemorySize: 256
Resources:
  HamoProTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: HamoPro
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      - AttributeName: InviteCodeIndexPK
        AttributeType: S
      - AttributeName: InviteCodeIndexSK
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: InviteCodeIndex
        KeySchema:
        - AttributeName: InviteCodeIndexPK
          KeyType: HASH
        - AttributeName: InviteCodeIndexSK
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
  ChatMessagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: HamoChatMessages
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
  HamoHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
        - http://localhost:5174
        AllowHeaders:
        - authorization
        - content-type
        AllowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        MaxAge: 600
      Auth:
        Authorizers:
          CognitoAuthorizer:
            IdentitySource: $request.header.Authorization
            JwtConfiguration:
              issuer: https://cognito-idp.ap-east-1.amazonaws.com/ap-east-1_LguNAJT1O
              audience:
              - j6ajfbnjhr6oji1j8jbtou4k7
        DefaultAuthorizer: CognitoAuthorizer
  AvatarsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AvatarsFunction
      Handler: index.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: HamoProTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: HamoProTable
      Events:
        GetAvatars:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /avatars
            Method: GET
        CreateAvatar:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /avatars
            Method: POST
        UpdateAvatar:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /avatars/{avatarId}
            Method: PUT
        DeleteAvatar:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /avatars/{avatarId}
            Method: DELETE
    Metadata:
      SamResourceId: AvatarsFunction
  ClientsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ClientsFunction
      Handler: index.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: HamoProTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: HamoProTable
      Events:
        GetClients:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /clients
            Method: GET
        CreateClient:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /clients
            Method: POST
        UpdateClient:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /clients/{clientId}
            Method: PUT
        DeleteClient:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /clients/{clientId}
            Method: DELETE
    Metadata:
      SamResourceId: ClientsFunction
  UserInitFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UserInitFunction
      Handler: index.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: HamoProTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: HamoProTable
      Events:
        InitUser:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /user/init
            Method: POST
    Metadata:
      SamResourceId: UserInitFunction
  InvitesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: InvitesFunction
      Handler: index.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: HamoProTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: HamoProTable
      Events:
        CreateInvite:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /invites
            Method: POST
    Metadata:
      SamResourceId: InvitesFunction
  AcceptInviteFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AcceptInviteFunction
      Handler: index.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: HamoProTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: HamoProTable
      Events:
        AcceptInvite:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /invites/accept
            Method: POST
    Metadata:
      SamResourceId: AcceptInviteFunction
  UserChatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UserChatsFunction
      Handler: index.handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: HamoProTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: HamoProTable
      Events:
        GetUserChats:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /user/chats
            Method: GET
        CreateUserChat:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /user/chats
            Method: POST
        DeleteUserChat:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /user/chats/{clientId}/{avatarId}
            Method: DELETE
    Metadata:
      SamResourceId: UserChatsFunction
  ChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ChatFunction
      Handler: index.handler
      Timeout: 30
      Environment:
        Variables:
          CHAT_TABLE_NAME:
            Ref: ChatMessagesTable
          GEMINI_API_KEY: '{{resolve:ssm:/hamo/gemini-api-key:1}}'
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ChatMessagesTable
      Events:
        GenerateChat:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /chat
            Method: POST
        GetChatHistory:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /chat/history
            Method: GET
        SaveChatMessage:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /chat/message
            Method: POST
        GetConversations:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HamoHttpApi
            Path: /chat/conversations
            Method: GET
    Metadata:
      SamResourceId: ChatFunction
Outputs:
  ApiUrl:
    Description: Hamo HTTP API URL
    Value:
      Fn::Sub: https://${HamoHttpApi}.execute-api.${AWS::Region}.amazonaws.com
